name:  SBOM (Scribe) CLI GIT Commit

on:
    workflow_dispatch:

env:
  SCRIBE_CLIENT_ID: ${{ secrets.CLIENT_ID }}
  SCRIBE_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
  COMPANY_CA: ${{ secrets.COMPANY_CA }}
  SIGNER_CERT: ${{ secrets.SIGNER_CERT }}
  SIGNER_KEY: ${{ secrets.SIGNER_KEY }}
  APP_IMAGE: prod-images.mgti-dal-so-art.mrshmc.com/whitehat-assets-onboading/api:1.1.100
  PRODUCT_KEY: demo-sign-and-integrity
  GITHUB_RUN_ID: ${{ github.run_id }}

permissions:
  contents: read

jobs:
  scribe-sign:
    name: Generate SBOM Git Commit
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0d381219ddf674d61a7572ddd19d7941e271515c # v2.9.0
        with:
          egress-policy: audit

      - name: checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
        
      - name: install valint
        run: curl -sSfL https://get.scribesecurity.com/install.sh  | sh -s -- -t valint

      - name: sbom attest git
        run: |
         $HOME/.scribe/bin/valint bom git:. \
         --components packages,files,dep \
         --format attest \
         --scribe.enable \
         --scribe.client-id $SCRIBE_CLIENT_ID \
         --scribe.client-secret $SCRIBE_CLIENT_SECRET \
         --product-key $PRODUCT_KEY \
         --attest.default x509 \
         --config .valint.yaml \
         --force \
         --verbose 2 \
         --context-type "github" \
         --label "is_git_commit"
      

